#!/bin/bash
set -euo pipefail

# Project file aggregator
# Combines source files into a single text file

# === CONFIGURATION ===
OUTPUT_FILE="project.txt"

# === CLEANUP ===
rm -f "${OUTPUT_FILE}"

# === FILE DISCOVERY ===
echo "Aggregating project files..."

find . \( \
    -path '*/.*' -prune -o \
    -path '*/node_modules' -prune -o \
    -path '*/bin' -prune -o \
    -path '*/obj' -prune -o \
    -path '*/out' -prune -o \
    -path '*/target' -prune -o \
    -path '*/coverage' -prune -o \
    -path '*/.nyc_output' -prune -o \
    -path '*/reports' -prune -o \
    -path '*/logs' -prune -o \
    -path '*/wwwroot/lib' -prune -o \
    -path '*/Migrations' -prune -o \
    -type f \
    ! -name '*.png' \
    ! -name '*.jpg' \
    ! -name '*.jpeg' \
    ! -name '*.gif' \
    ! -name '*.webp' \
    ! -name '*.svg' \
    ! -name '*.ico' \
    ! -name '*.ttf' \
    ! -name '*.woff' \
    ! -name '*.woff2' \
    ! -name '*.txt' \
    ! -name '*.json' \
    ! -name '*.lock' \
    ! -name '*.log' \
    ! -name '*.env' \
    ! -name '.gitignore' \
    ! -name '.DS_Store' \
    ! -name 'package-lock.json' \
    ! -name 'yarn.lock' \
    ! -name 'pnpm-lock.yaml' \
    ! -name '*~' \
    ! -name '*.swp' \
    ! -name 'Thumbs.db' \
    ! -name '.editorconfig' \
    ! -name '.dockerignore' \
    ! -name '.eslintrc*' \
    ! -name '.prettierrc*' \
    ! -name '.stylelintrc*' \
    ! -name '*.dll' \
    ! -name '*.exe' \
    ! -name '*.pdb' \
    ! -name '*.class' \
    ! -name '*.jar' \
    ! -name '*.xproj' \
    ! -name '*.csproj' \
    ! -name '*.vbproj' \
    ! -name '*.fsproj' \
    ! -name '*.props' \
    ! -name '*.targets' \
    ! -name 'Dockerfile' \
    ! -name 'docker-compose.*' \
    -print \) | while IFS= read -r file; do

    # Process each file
    {
        echo "### ${file}"
        cat "${file}"
        printf "\n\n"
    } >>"${OUTPUT_FILE}"
done

echo "Files aggregated into ${OUTPUT_FILE}"
