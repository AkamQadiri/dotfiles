#!/bin/bash
set -euo pipefail

# System maintenance utility
# Cleans package cache, logs, and temporary files

# === PERMISSION CHECK ===
if [[ "$(id -u)" -eq 0 ]]; then
    echo "Error: This script cannot be run as root"
    exit 1
fi

clear

# === PACKAGE CACHE CLEANUP ===
echo "Cleaning package cache..."
sudo pacman -Scc --noconfirm

# Clean AUR cache
if command -v yay &>/dev/null; then
    echo "Cleaning AUR cache..."
    yay -Scc --noconfirm
fi

# Remove orphaned packages
orphans=$(sudo pacman -Qdtq || true)
if [[ -n "${orphans}" ]]; then
    echo "Removing orphaned packages..."
    # shellcheck disable=SC2086  # We need word splitting
    sudo pacman -Rns ${orphans} --noconfirm
fi

# === LOG CLEANUP ===
echo "Clearing system logs..."
sudo tee /var/log/wtmp /var/log/btmp </dev/null
sudo journalctl --rotate
sudo journalctl --vacuum-time=1s

# === DIRECTORY CLEANUP ===
SYSTEM_DIRECTORIES=(
    "/var/log/journal"
    "/var/log/libvirt"
    "/var/tmp"
    "/var/cache/fontconfig"
)

USER_DIRECTORIES=(
    # General cache
    "${HOME}/.cache"

    # Logs and state
    "${HOME}/.local/pipx/logs"
    "${HOME}/.local/share/Trash"
    "${HOME}/.local/share/xorg"
    "${HOME}/.local/state/mpv"
    "${HOME}/.local/state/wireplumber"
    "${HOME}/.local/state/nvim"

    # Development
    "${HOME}/.npm/_cacache"
    "${HOME}/.nuget/packages"

    # Thumbnails
    "${HOME}/.thumbnails"
)

clean_directories() {
    local directories=("$@")
    for dir in "${directories[@]}"; do
        if [[ -d "${dir}" ]]; then
            find "${dir}" -mindepth 1 -delete 2>/dev/null || true
            echo "Cleaned: ${dir}"
        fi
    done
}

# Execute cleanup
echo "Cleaning system directories..."
for dir in "${SYSTEM_DIRECTORIES[@]}"; do
    if [[ -d "${dir}" ]]; then
        sudo find "${dir}" -mindepth 1 -delete 2>/dev/null || true
        echo "Cleaned: ${dir}"
    fi
done

echo "Cleaning user directories..."
clean_directories "${USER_DIRECTORIES[@]}"

# === HISTORY CLEANUP ===
echo "Clearing bash history..."
cat /dev/null >"${HOME}/.bash_history"
history -c && history -w

echo "System cleanup complete!"
